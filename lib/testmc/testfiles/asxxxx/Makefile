#   This Makefile produces the assembler and linker output files from
#   {narrow,wide}.a65 which are used by the test system for the
#   testmc.asxxxx module. These files are committed, so you do not
#   need to run this unless you've modified the .a65 files, in which
#   case you should commit the new generated files along with your
#   test framework changes.
#
#   It's somewhat fragile because it has various assumptions built
#   into it about what's been previously run, and also has to be
#   careful about the order in which we generate files to ensure we
#   get the correct versions of ones that get generated multiple
#   times, such as `.lst` files.

PATH := ../../../../.build/bin:${PATH}
SHELL := bash
export PATH SHELL

ASMOPTS = -xpr
LINKOPTS = -nmu

.PHONY: all

all: narrow.rst wide.rst

clean:
	rm -f *.{hlr,lst,map,rel,rst,sym}

####################################################################
#   Generic rules. These produce wide symbol listings.

#   We want to keep all output from the intermediate chains below;
#   the easiest hack for this is an empty .SECONDARY target.
#   (Trying to specify specific names to keep is tricky.)
.SECONDARY:

#   We use this to generate only the .sym file because the .lst file
#   is be generated without a symbol table when a .sym file is also
#   generated.
%.sym: %.a65
	as6500 ${ASMOPTS} -w -s $<

#   This is dependent on the .sym file to ensure that that's generated
#   first, ensuring any other files generated by that rule (though there
#   should be none) are overwritten by files generated by this one.
%.lst %.hlr %.rel: %.a65 %.sym
	as6500 ${ASMOPTS} -w -lo $<

#   Dependent also on %.lst because this is read to produce the .rst file.
%.rst %.map %.bin: %.rel %.lst
	aslink ${LINKOPTS} -w $<

####################################################################
#   Overrides for narrow.a65 to avoid producing wide symbol listings

narrow.sym: narrow.a65
	as6500 ${ASMOPTS} -s $^

narrow.lst narrow.hlr narrow.rel: narrow.a65 narrow.sym
	as6500 ${ASMOPTS} -lo $<

narrow.rst narrow.map: narrow.rel narrow.lst
	aslink ${LINKOPTS} $<

####################################################################
#   Override for wide.a65 link so we can test relocated offsets.

#   Depends on Makefile because -b options here change output.
wide.rst wide.map wide.bin: wide.rel wide.lst Makefile
	aslink ${LINKOPTS} -w -b _code=0x800 -b area_rel=0x1A2B $<
